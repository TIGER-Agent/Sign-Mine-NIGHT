<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assign Worker Slot - TIGER Agent</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #121212; color: #e0e0e0; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; margin: 0; padding-top: 50px; }
        .container { background-color: #1e1e1e; padding: 30px 40px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.4); max-width: 800px; width: 90%; }
        h1 { color: #f39c12; margin-bottom: 10px; text-align: center; }
        h2 { color: #ccc; border-bottom: 1px solid #444; padding-bottom: 10px; margin-top: 30px; }
        .button { background-color: #f39c12; color: #121212; border: none; padding: 12px 24px; font-size: 16px; font-weight: bold; border-radius: 8px; cursor: pointer; transition: background-color 0.3s, transform 0.2s; }
        .button:hover:not(:disabled) { background-color: #e67e22; transform: translateY(-2px); }
        .button:disabled { background-color: #555; color: #888; cursor: not-allowed; transform: none; }
        .connect-section { text-align: center; margin-bottom: 30px; }
        #status-text { text-align: center; margin-top: 20px; font-style: italic; color: #777; height: 20px; transition: color 0.3s; }
        .slot-list { margin-top: 20px; }
        .slot { display: flex; justify-content: space-between; align-items: center; background-color: #2a2a2a; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #444; }
        .slot.operator { border-left-color: #f39c12; }
        .slot.partner { border-left-color: #3498db; }
        .slot-info { font-family: "Courier New", Courier, monospace; }
        .slot-info .tag { font-weight: bold; }
        .slot-info .address { color: #999; font-size: 0.9em; }
        .assign-btn { background-color: #27ae60; }
        .assign-btn:hover:not(:disabled) { background-color: #2ecc71; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Công cụ Gán Slot Worker</h1>
        
        <div class="connect-section">
            <button id="connectBtn" class="button">Kết nối Ví (Eternl/Yoroi)</button>
        </div>

        <div id="status-text">Vui lòng kết nối ví để bắt đầu...</div>

        <div id="main-content" style="display: none;">
            <h2 id="vps-title"></h2>
            <div id="slot-container" class="slot-list">
                <!-- Các slot sẽ được render ở đây bằng Javascript -->
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- !!! QUAN TRỌNG: Cấu hình URL và Tên VPS tại đây !!! ---
    const C2_API_URL = "https://script.google.com/macros/s/AKfycbwr8EVpgbB-occKnqIiVwq4bCAC0giw8kN8OOXCtcwmY5QBA5MahyMrppEoCDtcgvq-ew/exec";
    const VPS_NAME_TO_MANAGE = "vps-contabo-test-01";
    // -----------------------------------------------------------

    const MESSAGE_TO_SIGN_HEX = "4d696e65204e49474854"; // "Mine NIGHT" encoded to Hex

    const connectBtn = document.getElementById('connectBtn');
    const statusText = document.getElementById('status-text');
    const mainContent = document.getElementById('main-content');
    const vpsTitle = document.getElementById('vps-title');
    const slotContainer = document.getElementById('slot-container');

    let walletAPI = null;

    const updateStatus = (message, isError = false) => {
        statusText.textContent = message;
        statusText.style.color = isError ? '#e74c3c' : '#2ecc71';
    };

    const fetchMachineConfig = async () => {
        updateStatus('Đang tải cấu hình máy chủ...');
        try {
            const response = await fetch(`${C2_API_URL}?action=get_vps_config&vps_name=${VPS_NAME_TO_MANAGE}`);
            if (!response.ok) throw new Error(`Lỗi mạng: ${response.statusText}`);
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);
            
            renderWorkerSlots(result.data);
            mainContent.style.display = 'block';
            updateStatus('Đã tải cấu hình thành công.', false);
        } catch (error) {
            console.error("Lỗi khi tải cấu hình:", error);
            updateStatus(`Không thể tải cấu hình: ${error.message}`, true);
        }
    };

    const renderWorkerSlots = (config) => {
        vpsTitle.textContent = `Trạng thái các Slot trên: ${config.vpsName}`;
        slotContainer.innerHTML = ''; // Xóa nội dung cũ

        config.slots.forEach((slot, index) => {
            const isOperatorSlot = index === 0;
            const slotType = isOperatorSlot ? 'Operator' : 'Partner';
            const slotDiv = document.createElement('div');
            slotDiv.className = `slot ${isOperatorSlot ? 'operator' : 'partner'}`;
            
            let content = '';
            if (slot) { // Slot đã được gán
                content = `
                    <div class="slot-info">
                        <span class="tag">[Slot ${index} - ${slotType}]</span><br>
                        <span class="address">Đã gán: ${slot.walletAddress.substring(0, 40)}...</span>
                    </div>
                    <button class="button" disabled>Đã gán</button>
                `;
            } else { // Slot trống
                content = `
                    <div class="slot-info">
                        <span class="tag">[Slot ${index} - ${slotType}]</span><br>
                        <span class="address">Trạng thái: Trống</span>
                    </div>
                    <button id="assign-btn-${index}" class="button assign-btn" onclick="window.assignSlot(${index}, ${isOperatorSlot})">Ký & Gán</button>
                `;
            }
            slotDiv.innerHTML = content;
            slotContainer.appendChild(slotDiv);
        });
    };

    window.assignSlot = async (slotIndex, isOperatorSlot) => {
        if (!walletAPI) {
            updateStatus('Lỗi: Ví chưa được kết nối.', true);
            return;
        }

        const assignBtn = document.getElementById(`assign-btn-${slotIndex}`);
        assignBtn.disabled = true;
        assignBtn.textContent = 'Đang ký...';
        updateStatus(`Đang chuẩn bị ký cho Slot ${slotIndex}...`);

        try {
            // 1. Lấy địa chỉ chưa sử dụng
            const unusedAddresses = await walletAPI.getUnusedAddresses();
            if (unusedAddresses.length === 0) throw new Error("Không tìm thấy địa chỉ chưa sử dụng trong ví.");
            const addressToSign = unusedAddresses[0];

            // 2. Yêu cầu ký
            updateStatus('Vui lòng xác nhận giao dịch ký trong ví của bạn...');
            const signaturePayload = await walletAPI.signData(addressToSign, MESSAGE_TO_SIGN_HEX);

            // 3. Đóng gói và gửi dữ liệu lên C2
            updateStatus('Đang gửi dữ liệu đã ký lên máy chủ...');
            const dataToSend = {
                vps_name: VPS_NAME_TO_MANAGE,
                slot_index: slotIndex,
                is_operator_slot: isOperatorSlot,
                address: addressToSign,
                publicKey: signaturePayload.key,
                signature: signaturePayload.signature
            };

            const response = await fetch(`${C2_API_URL}?action=assign_slot&data=${encodeURIComponent(JSON.stringify(dataToSend))}`);
            if (!response.ok) throw new Error(`Lỗi mạng khi gán slot: ${response.statusText}`);
            const result = await response.json();
            if (result.status !== 'success') throw new Error(result.message);

            updateStatus(`Gán Slot ${slotIndex} thành công! Đang làm mới...`, false);
            await fetchMachineConfig(); // Làm mới giao diện

        } catch (error) {
            console.error(`Lỗi khi gán slot ${slotIndex}:`, error);
            updateStatus(`Gán slot thất bại: ${error.message}`, true);
            assignBtn.disabled = false;
            assignBtn.textContent = 'Ký & Gán';
        }
    };

    connectBtn.addEventListener('click', async () => {
        if (typeof window.cardano === 'undefined') {
            updateStatus('Lỗi: Không tìm thấy ví Cardano. Vui lòng cài đặt extension.', true);
            return;
        }

        try {
            updateStatus('Đang chờ ví kết nối...');
            const enabledWallets = await window.cardano.getEnabledExtensions();
            if(enabledWallets.length === 0) {
                 updateStatus('Vui lòng chọn ví để kích hoạt...', true);
                 // Thử kích hoạt ví đầu tiên có thể tìm thấy, ví dụ Eternl
                 walletAPI = await window.cardano.eternl.enable();
            } else {
                 const walletName = enabledWallets[0].name;
                 walletAPI = await window.cardano[walletName].enable();
            }
            
            updateStatus('Kết nối ví thành công.', false);
            connectBtn.textContent = 'Đã kết nối';
            connectBtn.disabled = true;
            
            await fetchMachineConfig();

        } catch (error) {
            console.error("Kết nối ví thất bại:", error);
            updateStatus('Người dùng đã từ chối kết nối hoặc có lỗi xảy ra.', true);
            walletAPI = null;
        }
    });
});
</script>
</body>
</html>